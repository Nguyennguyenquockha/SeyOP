local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local player = Players.LocalPlayer
local startTime = tick()

-- Tọa độ an toàn
local safeZone = Vector3.new(20.25237464904785, 115.29972839355469, -237.6287384033203)

-- Thông báo khi chạy script
StarterGui:SetCore("SendNotification", {
    Title = "Notification",
    Text = "Thanks for using my script <3",
    Duration = 5,
    Button1 = "Ok! ",
})

local function getCharacter()
    local char = player.Character or player.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart", 5)
    return char, hrp
end

local noclipEnabled = false
local function setNoclip(enable)
    local char = player.Character
    if char then
        for _, part in pairs(char:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = not enable
            end
        end
    end
    noclipEnabled = enable
end

local function findCookies()
    local cookies = {}
    for _, obj in pairs(workspace.Map.Functional.SpawnedItems:GetChildren()) do
        if obj.Name == "CookieObject" and obj:FindFirstChild("CookiePrompt") and obj.PrimaryPart then
            table.insert(cookies, obj)
        end
    end
    return cookies
end

local function nearestCookies(hrp, cookies)
    table.sort(cookies, function(a,b)
        return (hrp.Position - a.PrimaryPart.Position).Magnitude < (hrp.Position - b.PrimaryPart.Position).Magnitude
    end)
    return cookies
end

local function teleportToCookie(cookie, hrp)
    if cookie and cookie.PrimaryPart then
        local targetPos = cookie.PrimaryPart.Position + Vector3.new(0,3,0)
        local char = player.Character
        if char and char.PrimaryPart then
            pcall(function() char:PivotTo(CFrame.new(targetPos)) end)
        elseif hrp then
            pcall(function() hrp.CFrame = CFrame.new(targetPos) end)
        end
    end
end

local function instantClickCookie(cookie)
    if cookie and cookie:FindFirstChild("CookiePrompt") then
        local prompt = cookie.CookiePrompt
        prompt.HoldDuration = 0
        pcall(function() fireproximityprompt(prompt) end)
    end
end

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CookieStatusGUI"
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0,280,0,220)
frame.Position = UDim2.new(0,20,0,20)
frame.BackgroundColor3 = Color3.fromRGB(40,40,40)
frame.BorderSizePixel = 0
frame.Parent = screenGui
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)
frame.Active = true
frame.Draggable = true

local outline = Instance.new("UIStroke")
outline.Parent = frame
outline.Thickness = 2
outline.Color = Color3.fromHSV(0,1,1)
outline.LineJoinMode = Enum.LineJoinMode.Round

local cookiesLabel = Instance.new("TextLabel")
cookiesLabel.Size = UDim2.new(1,-10,0,25)
cookiesLabel.Position = UDim2.new(0,5,0,5)
cookiesLabel.BackgroundTransparency = 1
cookiesLabel.TextColor3 = Color3.fromRGB(230,230,230)
cookiesLabel.Font = Enum.Font.SourceSansBold
cookiesLabel.TextScaled = true
cookiesLabel.Text = "Cookies: 0"
cookiesLabel.Parent = frame

local playerLabel = Instance.new("TextLabel")
playerLabel.Size = UDim2.new(1,-10,0,20)
playerLabel.Position = UDim2.new(0,5,0,35)
playerLabel.BackgroundTransparency = 1
playerLabel.TextColor3 = Color3.fromRGB(230,230,230)
playerLabel.Font = Enum.Font.SourceSansBold
playerLabel.TextScaled = true
playerLabel.Text = "Player: "..player.Name.." (Alive)"
playerLabel.Parent = frame

local noclipLabel = Instance.new("TextLabel")
noclipLabel.Size = UDim2.new(1,-10,0,20)
noclipLabel.Position = UDim2.new(0,5,0,55)
noclipLabel.BackgroundTransparency = 1
noclipLabel.TextColor3 = Color3.fromRGB(230,180,50)
noclipLabel.Font = Enum.Font.SourceSansBold
noclipLabel.TextScaled = true
noclipLabel.Text = "Noclip: OFF"
noclipLabel.Parent = frame

local farmingLabel = Instance.new("TextLabel")
farmingLabel.Size = UDim2.new(1,-10,0,20)
farmingLabel.Position = UDim2.new(0,5,0,75)
farmingLabel.BackgroundTransparency = 1
farmingLabel.TextColor3 = Color3.fromRGB(100,255,100)
farmingLabel.Font = Enum.Font.SourceSansBold
farmingLabel.TextScaled = true
farmingLabel.Text = "Farming: Stopped"
farmingLabel.Parent = frame

local timeLabel = Instance.new("TextLabel")
timeLabel.Size = UDim2.new(1,-10,0,25)
timeLabel.Position = UDim2.new(0,5,0,100)
timeLabel.BackgroundTransparency = 1
timeLabel.TextColor3 = Color3.fromRGB(230,230,230)
timeLabel.Font = Enum.Font.SourceSansBold
timeLabel.TextScaled = true
timeLabel.Text = "Time: 0s"
timeLabel.Parent = frame

local resetCountdownLabel = Instance.new("TextLabel")
resetCountdownLabel.Size = UDim2.new(1,-10,0,25)
resetCountdownLabel.Position = UDim2.new(0,5,0,125)
resetCountdownLabel.BackgroundTransparency = 1
resetCountdownLabel.TextColor3 = Color3.fromRGB(255,200,100)
resetCountdownLabel.Font = Enum.Font.SourceSansBold
resetCountdownLabel.TextScaled = true
resetCountdownLabel.Text = "Reset in: 164s"
resetCountdownLabel.Parent = frame

local dateLabel = Instance.new("TextLabel")
dateLabel.Size = UDim2.new(1,-10,0,20)
dateLabel.Position = UDim2.new(0,5,0,150)
dateLabel.BackgroundTransparency = 1
dateLabel.TextColor3 = Color3.fromRGB(200,255,200)
dateLabel.Font = Enum.Font.SourceSans
dateLabel.TextScaled = true
dateLabel.Text = "Date: "..os.date("%d/%m/%Y")
dateLabel.Parent = frame

local creditsLabel = Instance.new("TextLabel")
creditsLabel.Size = UDim2.new(1,-10,0,20)
creditsLabel.Position = UDim2.new(0,5,0,175)
creditsLabel.BackgroundTransparency = 1
creditsLabel.TextColor3 = Color3.fromRGB(200,200,255)
creditsLabel.Font = Enum.Font.SourceSans
creditsLabel.TextScaled = true
creditsLabel.Text = "Credits: Sey (Kha hub)"
creditsLabel.Parent = frame

local playersLabel = Instance.new("TextLabel")
playersLabel.Size = UDim2.new(1,-10,0,25)
playersLabel.Position = UDim2.new(0,5,0,200)
playersLabel.BackgroundTransparency = 1
playersLabel.TextColor3 = Color3.fromRGB(255,200,200)
playersLabel.Font = Enum.Font.SourceSans
playersLabel.TextScaled = true
playersLabel.Text = "Others: none"
playersLabel.Parent = frame

-- Countdown reset
local resetInterval = 164
local nextReset = tick() + resetInterval

-- Auto farm
RunService.Heartbeat:Connect(function()
    local char, hrp = getCharacter()
    local cookies = findCookies()
    cookies = nearestCookies(hrp, cookies)

    if #cookies > 0 then
        if not noclipEnabled then setNoclip(true) end
        noclipLabel.Text = "Noclip: ON"
        cookiesLabel.TextColor3 = Color3.fromRGB(230,230,230)
        farmingLabel.Text = "Farming: ON"
        farmingLabel.TextColor3 = Color3.fromRGB(100,255,100)

        for _, cookie in ipairs(cookies) do
            teleportToCookie(cookie, hrp)
            task.wait(0.08)
            instantClickCookie(cookie)
        end
    else
        -- Hết bánh -> TP safe zone
        if hrp then
            hrp.CFrame = CFrame.new(safeZone)
        end

        if noclipEnabled then setNoclip(false) end
        noclipLabel.Text = "Noclip: OFF"
        cookiesLabel.TextColor3 = Color3.fromRGB(180,180,180)
        farmingLabel.Text = "Farming: Stopped"
        farmingLabel.TextColor3 = Color3.fromRGB(255,100,100)
    end

    cookiesLabel.Text = "Cookies: "..#cookies
    playerLabel.Text = "Player: "..player.Name.." ("..(char.Humanoid.Health>0 and "Alive" or "Dead")..")"
    timeLabel.Text = string.format("Time: %ds", math.floor(tick()-startTime))

    local countdown = math.max(0, math.floor(nextReset - tick()))
    resetCountdownLabel.Text = "Reset in: "..countdown.."s"

    local names = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= player then
            table.insert(names, plr.Name)
        end
    end
    playersLabel.Text = "Others: "..(#names > 0 and table.concat(names, ", ") or "none")
end)

workspace.Map.Functional.SpawnedItems.ChildAdded:Connect(function(cookie)
    if cookie.Name == "CookieObject" and cookie:FindFirstChild("CookiePrompt") and cookie.PrimaryPart then
        local char, hrp = getCharacter()
        if not noclipEnabled then setNoclip(true) end
        teleportToCookie(cookie, hrp)
        task.wait(0.08)
        instantClickCookie(cookie)
    end
end)

-- Auto retry khi chết
task.spawn(function()
    while true do
        task.wait(0.5)
        local char = player.Character or player.CharacterAdded:Wait()
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid and humanoid.Health <= 0 then
            ReplicatedStorage:WaitForChild("Events"):WaitForChild("GameEvent"):FireServer("VoteRetry")
            task.wait(3)
        end
    end
end)

-- Rainbow viền
task.spawn(function()
    local hue = 0
    while true do
        hue = (hue + 0.005) % 1
        outline.Color = Color3.fromHSV(hue,1,1)
        task.wait(0.03)
    end
end)

-- Auto reset mỗi 164 giây
task.spawn(function()
    while true do
        task.wait(resetInterval)
        nextReset = tick() + resetInterval
        local char = player.Character or player.CharacterAdded:Wait()
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.Health = 0
            StarterGui:SetCore("SendNotification", {
                Title = "Auto Reset",
                Text = "Nhân vật đã được reset sau 164 giây!",
                Duration = 5,
            })
        end
    end
end)